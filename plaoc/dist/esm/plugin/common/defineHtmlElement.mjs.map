{"version":3,"file":"defineHtmlElement.mjs","sources":["../../../../plugin/common/defineHtmlElement.ts"],"sourcesContent":["import { Evt } from \"./EvtOut\";\n\nexport const defineHtmlElement = <T extends {}>(\n  names: { tag_name: string; tagName: string },\n  apis: T,\n  lifecycle: { onCreate: () => unknown }\n) => {\n  const evt_hubs = new Set<Evt>();\n  const func_name_list: string[] = [];\n  const readonly_name_list: string[] = [];\n  const prop_name_list: string[] = [];\n  const define_list: [p: PropertyKey, attributes: PropertyDescriptor][] = [];\n\n  /// 获取所有的属性\n  const propDescMap = new Map<string, PropertyDescriptor>();\n  let value: any = apis;\n  do {\n    for (const [prop, desc] of Object.entries(\n      Object.getOwnPropertyDescriptors(value)\n    )) {\n      /// 忽略私有的\n      if (prop.startsWith(\"_\")) {\n        continue;\n      }\n\n      if (propDescMap.has(prop)) {\n        continue;\n      }\n      propDescMap.set(prop, desc);\n    }\n    value = Object.getPrototypeOf(apis);\n    if (value === Object.prototype) {\n      break;\n    }\n  } while (true);\n\n  /// 遍历所有的属性，进行动态生产\n  const handlePropDesc = (prop: string, desc: PropertyDescriptor) => {\n    if (prop.startsWith(\"on\") && typeof desc.get === \"function\") {\n      const eventName = prop.substring(2).toLowerCase();\n\n      let on_event: Function | null = null;\n      let on_evt: Evt | undefined;\n      define_list.push([\n        `on${eventName}`,\n        {\n          get() {\n            return on_event || null;\n          },\n          set(cb: Function) {\n            if (typeof cb === \"function\") {\n              on_event = cb;\n              if (on_evt === undefined) {\n                (async () => {\n                  const evt = (on_evt = desc.get!.call(apis) as unknown as Evt);\n                  evt_hubs.add(evt);\n                  for await (const data of evt) {\n                    const event = new CustomEvent(eventName, { detail: data });\n                    on_event?.(event);\n                  }\n                })();\n              }\n            } else {\n              on_event = null;\n              if (on_evt !== undefined) {\n                on_evt.return();\n                evt_hubs.delete(on_evt);\n              }\n            }\n          },\n        },\n      ]);\n    } else if (typeof desc.value === \"function\") {\n      func_name_list.push(prop);\n    } else if (\"value\" in desc) {\n      prop_name_list.push(prop);\n    } else if (\"set\" in desc) {\n      if (desc.set === undefined) {\n        readonly_name_list.push(prop);\n      } else {\n        prop_name_list.push(prop);\n      }\n    }\n  };\n  for (const [prop, desc] of propDescMap) {\n    handlePropDesc(prop, desc);\n  }\n\n  /// build html element constructor\n  const HTMLConstructor = Function(\n    \"apis\",\n    \"evt_hubs\",\n    \"lifecycle\",\n    `return class HTML${names.tagName} extends HTMLElement {\n        constructor(){\n            super()\n            lifecycle.onCreate && lifecycle.onCreate(this)\n        }\n        disconnectedCallback() {\n          for (const evt of evt_hubs) {\n            evt.return();\n          }\n        }\n        ${func_name_list\n          .map(\n            (func_name) =>\n              `${func_name}(...args) { return apis.${func_name}(...args) }`\n          )\n          .join(\"\\n\")}\n        ${readonly_name_list\n          .map(\n            (readonly_name) =>\n              `get ${readonly_name}() { return apis.${readonly_name} }`\n          )\n          .join(\"\\n\")}\n        ${prop_name_list\n          .map(\n            (prop_name) =>\n              `get ${prop_name}() { return apis.${prop_name} }\\n` +\n              `set ${prop_name}(v) { return apis.${prop_name}(v) }`\n          )\n          .join(\"\\n\")}\n      }`\n  )(apis, evt_hubs) as typeof HTMLElement;\n  customElements.define(names.tag_name, HTMLConstructor);\n  return HTMLConstructor;\n};\n"],"names":[],"mappings":"AAEO,MAAM,oBAAoB,CAC/B,OACA,MACA,cACG;AACG,QAAA,+BAAe;AACrB,QAAM,iBAA2B,CAAA;AACjC,QAAM,qBAA+B,CAAA;AACrC,QAAM,iBAA2B,CAAA;AAI3B,QAAA,kCAAkB;AACxB,MAAI,QAAa;AACd,KAAA;AACU,eAAA,CAAC,MAAM,SAAS,OAAO,QAChC,OAAO,0BAA0B,KAAK,CACxC,GAAG;AAEG,UAAA,KAAK,WAAW,GAAG,GAAG;AACxB;AAAA,MACF;AAEI,UAAA,YAAY,IAAI,IAAI,GAAG;AACzB;AAAA,MACF;AACY,kBAAA,IAAI,MAAM,IAAI;AAAA,IAC5B;AACQ,YAAA,OAAO,eAAe,IAAI;AAC9B,QAAA,UAAU,OAAO,WAAW;AAC9B;AAAA,IACF;AAAA,EACO,SAAA;AAGH,QAAA,iBAAiB,CAAC,MAAc,SAA6B;AACjE,QAAI,KAAK,WAAW,IAAI,KAAK,OAAO,KAAK,QAAQ,YAAY;AACzC,WAAK,UAAU,CAAC,EAAE,YAAY;AAAA,IAiCvC,WAAA,OAAO,KAAK,UAAU,YAAY;AAC3C,qBAAe,KAAK,IAAI;AAAA,IAAA,WACf,WAAW,MAAM;AAC1B,qBAAe,KAAK,IAAI;AAAA,IAAA,WACf,SAAS,MAAM;AACpB,UAAA,KAAK,QAAQ,QAAW;AAC1B,2BAAmB,KAAK,IAAI;AAAA,MAAA,OACvB;AACL,uBAAe,KAAK,IAAI;AAAA,MAC1B;AAAA,IACF;AAAA,EAAA;AAES,aAAA,CAAC,MAAM,SAAS,aAAa;AACtC,mBAAe,MAAM,IAAI;AAAA,EAC3B;AAGA,QAAM,kBAAkB,SACtB,QACA,YACA,aACA,oBAAoB,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAUpB,eACC,IACC,CAAC,cACC,GAAG,oCAAoC,sBAC3C,EACC,KAAK,IAAI;AAAA,UACV,mBACC,IACC,CAAC,kBACC,OAAO,iCAAiC,iBAC5C,EACC,KAAK,IAAI;AAAA,UACV,eACC,IACC,CAAC,cACC,OAAO,6BAA6B;AAAA,MAC7B,8BAA8B,gBACzC,EACC,KAAK,IAAI;AAAA,QAElB,EAAE,MAAM,QAAQ;AACD,iBAAA,OAAO,MAAM,UAAU,eAAe;AAC9C,SAAA;AACT;;"}